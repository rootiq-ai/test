<dashboard version="1.1" script="alerting_framework.js" stylesheet="alerting_framework.css">
  <label>Alerting Framework</label>
  <description>Create and manage Splunk alerts - by Kamal Bisht</description>
  
  <fieldset submitButton="false" autoRun="false">
    <input type="time" token="duration_token" searchWhenChanged="false">
      <label></label>
      <default>
        <earliest>-15m</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>
  
  <row>
    <panel>
      <html>
        <div id="quick-start-header" style="background:#4caf50;color:white;padding:12px;border-radius:4px;cursor:pointer;">
          <span id="qs-icon">â–¶</span> Quick Start - Macros, Examples &amp; Templates
        </div>
      </html>
    </panel>
  </row>
  
  <row id="quick_start_content">
    <panel>
      <title>Macros</title>
      <html>
        <div id="macros-container" style="max-height:250px;overflow-y:auto;border:1px solid #ddd;padding:10px;border-radius:4px;">Loading macros...</div>
        <button class="btn btn-default btn-sm" id="btn-refresh-macros" style="margin-top:10px;">Refresh</button>
      </html>
    </panel>
    <panel>
      <title>Examples</title>
      <html>
        <div style="max-height:250px;overflow-y:auto;border:1px solid #ddd;padding:10px;border-radius:4px;">
          <div style="margin-bottom:10px;padding:10px;background:#f5f5f5;border-radius:4px;">
            <strong>Internal Logs</strong>
            <pre style="font-size:11px;">index=_internal | stats count by component | head 10</pre>
            <button class="btn btn-default btn-xs btn-use-example" data-query="index=_internal | stats count by component | head 10">Use</button>
          </div>
          <div style="margin-bottom:10px;padding:10px;background:#f5f5f5;border-radius:4px;">
            <strong>Index Stats</strong>
            <pre style="font-size:11px;">index=* | stats count by index | head 10</pre>
            <button class="btn btn-default btn-xs btn-use-example" data-query="index=* | stats count by index | head 10">Use</button>
          </div>
          <div style="margin-bottom:10px;padding:10px;background:#f5f5f5;border-radius:4px;">
            <strong>Error Logs</strong>
            <pre style="font-size:11px;">index=_internal log_level=ERROR | stats count by component</pre>
            <button class="btn btn-default btn-xs btn-use-example" data-query="index=_internal log_level=ERROR | stats count by component">Use</button>
          </div>
          <div style="padding:10px;background:#f5f5f5;border-radius:4px;">
            <strong>Sourcetype Summary</strong>
            <pre style="font-size:11px;">index=* | stats count by sourcetype | head 20</pre>
            <button class="btn btn-default btn-xs btn-use-example" data-query="index=* | stats count by sourcetype | head 20">Use</button>
          </div>
        </div>
      </html>
    </panel>
    <panel>
      <title>Templates</title>
      <html>
        <div style="max-height:250px;overflow-y:auto;border:1px solid #ddd;padding:10px;border-radius:4px;">
          <div style="margin-bottom:10px;padding:10px;background:#f5f5f5;border-radius:4px;">
            <strong>Critical (P1)</strong>
            <p style="font-size:12px;margin:5px 0;">5-min frequency, ticket creation</p>
            <button class="btn btn-default btn-xs btn-use-template" data-tpl="critical">Apply</button>
          </div>
          <div style="margin-bottom:10px;padding:10px;background:#f5f5f5;border-radius:4px;">
            <strong>Warning (P2)</strong>
            <p style="font-size:12px;margin:5px 0;">15-min frequency, ticket creation</p>
            <button class="btn btn-default btn-xs btn-use-template" data-tpl="warning">Apply</button>
          </div>
          <div style="margin-bottom:10px;padding:10px;background:#f5f5f5;border-radius:4px;">
            <strong>Info (P3)</strong>
            <p style="font-size:12px;margin:5px 0;">Hourly, no ticket</p>
            <button class="btn btn-default btn-xs btn-use-template" data-tpl="info">Apply</button>
          </div>
          <div style="padding:10px;background:#f5f5f5;border-radius:4px;">
            <strong>Daily Report (P4)</strong>
            <p style="font-size:12px;margin:5px 0;">Daily at midnight</p>
            <button class="btn btn-default btn-xs btn-use-template" data-tpl="daily">Apply</button>
          </div>
        </div>
      </html>
    </panel>
  </row>
  
  <row>
    <panel>
      <html><hr style="margin:20px 0;"/></html>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Alert Configuration</title>
      <html>
        <div style="max-width:900px;">
          
          <div style="display:flex;gap:20px;margin-bottom:15px;">
            <div style="flex:2;">
              <label style="font-weight:bold;display:block;margin-bottom:5px;">Alert Name <span style="color:red;">*</span></label>
              <input type="text" id="fld_alert_name" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;" placeholder="Enter alert name"/>
              <div id="err_alert_name" style="color:#c62828;font-size:12px;margin-top:3px;display:none;"></div>
            </div>
            <div style="flex:1;">
              <label style="font-weight:bold;display:block;margin-bottom:5px;">Application Name <span style="color:red;">*</span></label>
              <input type="text" id="fld_app_name" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;" placeholder="e.g., MyApp"/>
              <div id="err_app_name" style="color:#c62828;font-size:12px;margin-top:3px;display:none;"></div>
            </div>
            <div style="flex:1;">
              <label style="font-weight:bold;display:block;margin-bottom:5px;">Ticket Creation <span style="color:red;">*</span></label>
              <select id="fld_ticket" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                <option value="no">No</option>
                <option value="yes">Yes</option>
              </select>
            </div>
          </div>
          
          <div id="ticket-fields-container" style="display:none;background:#f0f7ff;padding:15px;border-left:4px solid #2196f3;margin-bottom:15px;border-radius:4px;">
            <div style="display:flex;gap:20px;">
              <div style="flex:1;">
                <label style="font-weight:bold;display:block;margin-bottom:5px;">Event Class <span style="color:red;">*</span></label>
                <input type="text" id="fld_eventclass" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;" placeholder="e.g., Infrastructure"/>
                <div id="err_eventclass" style="color:#c62828;font-size:12px;margin-top:3px;display:none;"></div>
              </div>
              <div style="flex:1;">
                <label style="font-weight:bold;display:block;margin-bottom:5px;">Assignment Group <span style="color:red;">*</span></label>
                <input type="text" id="fld_assignment" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;" placeholder="e.g., Platform-Support"/>
                <div id="err_assignment" style="color:#c62828;font-size:12px;margin-top:3px;display:none;"></div>
              </div>
              <div style="flex:1;">
                <label style="font-weight:bold;display:block;margin-bottom:5px;">Org Code</label>
                <input type="text" id="fld_orgcode" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;" placeholder="e.g., ORG001"/>
              </div>
            </div>
          </div>
          
          <div style="margin-bottom:15px;">
            <label style="font-weight:bold;display:block;margin-bottom:5px;">Splunk Query <span style="color:red;">*</span></label>
            <textarea id="fld_query" rows="4" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;font-family:monospace;" placeholder="Enter SPL query..."></textarea>
            <div id="err_query" style="color:#c62828;font-size:12px;margin-top:3px;display:none;"></div>
            <div style="margin-top:5px;">
              <button class="btn btn-default btn-sm" id="btn-expand-macros">Expand Macros</button>
              <button class="btn btn-default btn-sm" id="btn-validate-query">Validate Query</button>
              <span id="query-status" style="margin-left:10px;"></span>
            </div>
          </div>
          
          <div style="display:flex;gap:20px;margin-bottom:15px;">
            <div style="flex:1;">
              <label style="font-weight:bold;display:block;margin-bottom:5px;">Email IDs <span style="color:red;">*</span></label>
              <input type="text" id="fld_email" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;" placeholder="user@domain.com"/>
              <div style="font-size:11px;color:#666;margin-top:3px;">Separate multiple with commas</div>
              <div id="err_email" style="color:#c62828;font-size:12px;margin-top:3px;display:none;"></div>
            </div>
            <div style="flex:1;">
              <label style="font-weight:bold;display:block;margin-bottom:5px;">Email Subject <span style="color:red;">*</span></label>
              <input type="text" id="fld_subject" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;" placeholder="Alert: $name$"/>
              <div id="err_subject" style="color:#c62828;font-size:12px;margin-top:3px;display:none;"></div>
            </div>
          </div>
          
          <div style="margin-bottom:15px;">
            <label style="font-weight:bold;display:block;margin-bottom:5px;">Email Body</label>
            <textarea id="fld_body" rows="2" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;" placeholder="Alert details..."></textarea>
          </div>
          
          <div style="display:flex;gap:20px;margin-bottom:20px;">
            <div style="flex:1;">
              <label style="font-weight:bold;display:block;margin-bottom:5px;">Priority</label>
              <select id="fld_priority" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                <option value="P1">P1 - Critical</option>
                <option value="P2">P2 - High</option>
                <option value="P3" selected="selected">P3 - Medium</option>
                <option value="P4">P4 - Low</option>
              </select>
            </div>
            <div style="flex:1;">
              <label style="font-weight:bold;display:block;margin-bottom:5px;">Duration</label>
              <div id="duration_picker_target"></div>
            </div>
            <div style="flex:1;">
              <label style="font-weight:bold;display:block;margin-bottom:5px;">Frequency</label>
              <select id="fld_frequency" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                <option value="*/5 * * * *">Every 5 min</option>
                <option value="*/15 * * * *" selected="selected">Every 15 min</option>
                <option value="*/30 * * * *">Every 30 min</option>
                <option value="0 * * * *">Hourly</option>
                <option value="0 */4 * * *">Every 4 hours</option>
                <option value="0 0 * * *">Daily (midnight)</option>
                <option value="0 8 * * *">Daily (8 AM)</option>
                <option value="0 0 * * 0">Weekly (Sunday)</option>
                <option value="0 0 1 * *">Monthly (1st)</option>
                <option value="custom">Custom (cron)...</option>
              </select>
              <input type="text" id="fld_custom_cron" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;margin-top:5px;display:none;" placeholder="*/10 * * * * (min hr day mon dow)"/>
            </div>
            <div style="flex:1;">
              <label style="font-weight:bold;display:block;margin-bottom:5px;">Threshold</label>
              <input type="number" id="fld_threshold" value="0" min="0" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;"/>
            </div>
            <div style="flex:1;">
              <label style="font-weight:bold;display:block;margin-bottom:5px;">Suppression (min)</label>
              <input type="number" id="fld_suppression" value="0" min="0" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;"/>
              <div style="font-size:10px;color:#666;margin-top:2px;">0=none, 5=5min, 60=1hr</div>
            </div>
          </div>
          
          <div style="margin-bottom:15px;">
            <button class="btn btn-default btn-lg" id="btn-preview">Preview</button>
            <button class="btn btn-primary btn-lg" id="btn-submit">Submit</button>
            <button class="btn btn-default btn-lg" id="btn-clear">Clear</button>
          </div>
          
          <div id="form-errors" style="display:none;background:#ffebee;color:#c62828;padding:12px;border-radius:4px;margin-bottom:15px;"></div>
          
        </div>
      </html>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Preview Results</title>
      <html>
        <div style="margin-bottom:10px;">
          <strong>Full Query:</strong>
          <pre id="preview-query" style="background:#f5f5f5;padding:10px;border-radius:4px;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word;max-height:150px;overflow-y:auto;">-</pre>
        </div>
        <div style="margin-bottom:10px;">
          <strong>Status:</strong> <span id="preview-status">Pending</span> |
          <strong>Time:</strong> <span id="preview-time">-</span> |
          <strong>Results:</strong> <span id="preview-count">-</span>
        </div>
        <div id="preview-results">Click Preview to run</div>
      </html>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Summary</title>
      <html>
        <table class="table" style="width:auto;">
          <tbody>
            <tr><td style="font-weight:bold;width:150px;">Alert Name:</td><td id="sum-name">-</td></tr>
            <tr><td style="font-weight:bold;">Application:</td><td id="sum-app">-</td></tr>
            <tr><td style="font-weight:bold;">Ticket:</td><td id="sum-ticket">-</td></tr>
            <tr><td style="font-weight:bold;">Email:</td><td id="sum-email">-</td></tr>
            <tr><td style="font-weight:bold;">Priority:</td><td id="sum-priority">-</td></tr>
            <tr><td style="font-weight:bold;">Duration:</td><td id="sum-duration">-</td></tr>
            <tr><td style="font-weight:bold;">Frequency:</td><td id="sum-frequency">-</td></tr>
            <tr><td style="font-weight:bold;">Threshold:</td><td id="sum-threshold">-</td></tr>
            <tr><td style="font-weight:bold;">Suppression:</td><td id="sum-suppression">-</td></tr>
            <tr><td style="font-weight:bold;">Query:</td><td id="sum-query" style="max-width:600px;word-wrap:break-word;font-family:monospace;font-size:11px;">-</td></tr>
          </tbody>
        </table>
        <button class="btn btn-warning" id="btn-ack" disabled="disabled">Acknowledge Configuration</button>
        <span id="ack-status" style="margin-left:10px;"></span>
      </html>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Existing Alerts</title>
      <html>
        <button class="btn btn-default" id="btn-load-alerts">Load Alerts</button>
        <input type="text" id="alert-filter" placeholder="Filter..." style="margin-left:10px;padding:6px;"/>
        <div id="alerts-list" style="margin-top:10px;">Click Load Alerts</div>
      </html>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Activity Log</title>
      <html>
        <button class="btn btn-default btn-sm" id="btn-clear-log">Clear</button>
        <div id="log" style="height:150px;overflow:auto;background:#fafafa;padding:10px;margin-top:10px;font-family:monospace;font-size:12px;">[Ready]</div>
      </html>
    </panel>
  </row>
  
</dashboard>
