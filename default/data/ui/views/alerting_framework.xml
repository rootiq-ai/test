<dashboard version="1.1" script="alerting_framework.js" stylesheet="alerting_framework.css">
  <label>Alerting Framework</label>
  <description>Create and manage Splunk alerts - by Kamal Bisht</description>
  
  <fieldset submitButton="false" autoRun="false">
    <input type="time" token="duration_token" searchWhenChanged="false">
      <label></label>
      <default>
        <earliest>-15m</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>
  
  <row>
    <panel>
      <html>
        <div id="quick-start-header" style="background:#4caf50;color:white;padding:12px;border-radius:4px;cursor:pointer;">
          <span id="qs-icon">â–¶</span> Quick Start - Macros, Examples &amp; Templates
        </div>
      </html>
    </panel>
  </row>
  
  <row id="quick_start_content">
    <panel>
      <title>Macros</title>
      <html>
        <div id="macros-container" style="max-height:250px;overflow-y:auto;overflow-x:hidden;border:1px solid #ddd;padding:10px;border-radius:4px;">Loading macros...</div>
        <button class="btn btn-default btn-sm" id="btn-refresh-macros" style="margin-top:10px;">Refresh</button>
      </html>
    </panel>
    <panel>
      <title>Examples</title>
      <html>
        <div id="examples-container" style="max-height:250px;overflow-y:auto;overflow-x:hidden;border:1px solid #ddd;padding:10px;border-radius:4px;">
          <div style="margin-bottom:8px;padding:8px;background:#f5f5f5;border-radius:4px;overflow:hidden;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
              <strong style="font-size:12px;">Internal Logs</strong>
              <button class="btn btn-primary btn-xs btn-use-example" data-query="index=_internal | stats count by component | head 10" style="padding:2px 8px;">Use</button>
            </div>
            <code style="font-size:10px;display:block;background:#e8e8e8;padding:5px;border-radius:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">index=_internal | stats count by component | head 10</code>
          </div>
          <div style="margin-bottom:8px;padding:8px;background:#f5f5f5;border-radius:4px;overflow:hidden;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
              <strong style="font-size:12px;">Index Stats</strong>
              <button class="btn btn-primary btn-xs btn-use-example" data-query="index=* | stats count by index | head 10" style="padding:2px 8px;">Use</button>
            </div>
            <code style="font-size:10px;display:block;background:#e8e8e8;padding:5px;border-radius:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">index=* | stats count by index | head 10</code>
          </div>
          <div style="margin-bottom:8px;padding:8px;background:#f5f5f5;border-radius:4px;overflow:hidden;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
              <strong style="font-size:12px;">Error Logs</strong>
              <button class="btn btn-primary btn-xs btn-use-example" data-query="index=_internal log_level=ERROR | stats count by component" style="padding:2px 8px;">Use</button>
            </div>
            <code style="font-size:10px;display:block;background:#e8e8e8;padding:5px;border-radius:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">index=_internal log_level=ERROR | stats count by component</code>
          </div>
          <div style="padding:8px;background:#f5f5f5;border-radius:4px;overflow:hidden;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
              <strong style="font-size:12px;">Sourcetype Summary</strong>
              <button class="btn btn-primary btn-xs btn-use-example" data-query="index=* | stats count by sourcetype | head 20" style="padding:2px 8px;">Use</button>
            </div>
            <code style="font-size:10px;display:block;background:#e8e8e8;padding:5px;border-radius:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">index=* | stats count by sourcetype | head 20</code>
          </div>
        </div>
      </html>
    </panel>
    <panel>
      <title>Templates</title>
      <html>
        <div id="templates-container" style="max-height:250px;overflow-y:auto;overflow-x:hidden;border:1px solid #ddd;padding:10px;border-radius:4px;">
          Loading templates...
        </div>
        <button class="btn btn-default btn-sm" id="btn-refresh-templates" style="margin-top:10px;">Refresh</button>
      </html>
    </panel>
  </row>
  
  <row>
    <panel>
      <html><hr style="margin:20px 0;"/></html>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Alert Configuration</title>
      <html>
        <div class="alert-form-container">
          
          <!-- Card 1: Alert Identity -->
          <div class="form-card">
            <div style="display:flex;gap:15px;margin-bottom:15px;">
              <div style="flex:2;">
                <label class="form-label">Alert Name <span style="color:red;">*</span></label>
                <input type="text" id="fld_alert_name" class="form-input" placeholder="Enter alert name"/>
                <div id="err_alert_name" class="form-error"></div>
              </div>
              <div style="flex:1;">
                <label class="form-label">Application Name <span style="color:red;">*</span></label>
                <input type="text" id="fld_app_name" class="form-input" placeholder="e.g., MyApp"/>
                <div id="err_app_name" class="form-error"></div>
              </div>
              <div style="flex:1;">
                <label class="form-label">Ticket Creation <span style="color:red;">*</span></label>
                <select id="fld_ticket" class="form-input">
                  <option value="no">No</option>
                  <option value="yes">Yes</option>
                </select>
              </div>
            </div>
            
            <!-- Ticket Fields (conditionally shown) -->
            <div id="ticket-fields-container" style="display:none;background:#e3f2fd;padding:12px;border-radius:4px;margin-top:10px;">
              <div style="display:flex;gap:15px;">
                <div style="flex:1;">
                  <label class="form-label">Priority</label>
                  <select id="fld_priority" class="form-input">
                    <option value="P1">P1 - Critical</option>
                    <option value="P2">P2 - High</option>
                    <option value="P3" selected="selected">P3 - Medium</option>
                    <option value="P4">P4 - Low</option>
                  </select>
                </div>
                <div style="flex:1;">
                  <label class="form-label">Event Class <span style="color:red;">*</span></label>
                  <input type="text" id="fld_eventclass" class="form-input" placeholder="e.g., Infrastructure"/>
                  <div id="err_eventclass" class="form-error"></div>
                </div>
                <div style="flex:1;">
                  <label class="form-label">Assignment Group <span style="color:red;">*</span></label>
                  <input type="text" id="fld_assignment" class="form-input" placeholder="e.g., Platform-Support"/>
                  <div id="err_assignment" class="form-error"></div>
                </div>
                <div style="flex:1;">
                  <label class="form-label">Org Code <span style="color:red;">*</span></label>
                  <input type="text" id="fld_orgcode" class="form-input" placeholder="e.g., ORG001"/>
                  <div id="err_orgcode" class="form-error"></div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Card 2: Splunk Query -->
          <div class="form-card">
            <label class="form-label">Splunk Query <span style="color:red;">*</span></label>
            <textarea id="fld_query" rows="4" class="form-input" style="font-family:monospace;" placeholder="Enter SPL query..."></textarea>
            <div id="err_query" class="form-error"></div>
            <div style="margin-top:8px;">
              <button class="btn btn-default btn-sm" id="btn-expand-macros">Expand Macros</button>
              <button class="btn btn-default btn-sm" id="btn-validate-query">Validate Query</button>
              <span id="query-status" style="margin-left:10px;font-weight:bold;"></span>
            </div>
          </div>
          
          <!-- Card 3: Two-column layout for Email and Schedule -->
          <div style="display:flex;gap:20px;">
            
            <!-- Left: Email Notification -->
            <div class="form-card" style="flex:1;">
              <div style="margin-bottom:12px;">
                <label class="form-label">Email IDs <span style="color:red;">*</span></label>
                <input type="text" id="fld_email" class="form-input" placeholder="user@domain.com"/>
                <div style="font-size:10px;color:#666;margin-top:2px;">Separate multiple with commas</div>
                <div id="err_email" class="form-error"></div>
              </div>
              <div style="margin-bottom:12px;">
                <label class="form-label">Email Subject <span style="color:red;">*</span></label>
                <input type="text" id="fld_subject" class="form-input" placeholder="Alert: $name$"/>
                <div id="err_subject" class="form-error"></div>
              </div>
              <div>
                <label class="form-label">Email Body <span style="color:red;">*</span></label>
                <textarea id="fld_body" rows="3" class="form-input" placeholder="Alert details..."></textarea>
                <div id="err_body" class="form-error"></div>
              </div>
            </div>
            
            <!-- Right: Schedule and Trigger -->
            <div class="form-card" style="flex:1;">
              <div style="display:flex;gap:15px;margin-bottom:12px;">
                <div style="flex:1;">
                  <label class="form-label">Duration</label>
                  <div id="duration_picker_target"></div>
                </div>
                <div style="flex:1;">
                  <label class="form-label">Frequency</label>
                  <select id="fld_frequency" class="form-input">
                    <option value="*/5 * * * *">Every 5 min</option>
                    <option value="*/15 * * * *" selected="selected">Every 15 min</option>
                    <option value="*/30 * * * *">Every 30 min</option>
                    <option value="0 * * * *">Hourly</option>
                    <option value="0 */4 * * *">Every 4 hours</option>
                    <option value="0 0 * * *">Daily (midnight)</option>
                    <option value="0 8 * * *">Daily (8 AM)</option>
                    <option value="0 0 * * 0">Weekly (Sunday)</option>
                    <option value="0 0 1 * *">Monthly (1st)</option>
                    <option value="custom">Custom (cron)...</option>
                  </select>
                  <input type="text" id="fld_custom_cron" class="form-input" style="margin-top:5px;display:none;" placeholder="*/10 * * * * (min hr day mon dow)"/>
                </div>
              </div>
              <div style="margin-bottom:12px;">
                <label class="form-label">Threshold</label>
                <input type="number" id="fld_threshold" value="0" min="0" class="form-input"/>
              </div>
              <div style="background:#f5f5f5;padding:10px;border-radius:4px;">
                <label style="font-weight:bold;cursor:pointer;">
                  <input type="checkbox" id="fld_throttle" style="margin-right:8px;"/>
                  Throttle
                </label>
                <span style="color:#666;font-size:11px;margin-left:5px;">Suppress triggering of actions</span>
                <div id="throttle-options" style="display:none;margin-top:8px;">
                  <label style="display:flex;align-items:center;gap:8px;font-size:12px;">
                    <span>Suppress for</span>
                    <input type="number" id="fld_suppression" value="60" min="1" style="width:70px;padding:6px;border:1px solid #ccc;border-radius:4px;"/>
                    <select id="fld_suppression_unit" style="padding:6px;border:1px solid #ccc;border-radius:4px;">
                      <option value="s">second(s)</option>
                      <option value="m" selected="selected">minute(s)</option>
                      <option value="h">hour(s)</option>
                    </select>
                  </label>
                </div>
              </div>
            </div>
            
          </div>
          
          <!-- Buttons -->
          <div style="margin-top:20px;text-align:center;">
            <button class="btn btn-default btn-lg" id="btn-preview">Preview</button>
            <button class="btn btn-primary btn-lg" id="btn-submit" style="margin:0 10px;">Submit</button>
            <button class="btn btn-default btn-lg" id="btn-clear">Clear</button>
          </div>
          
          <div id="form-errors" class="form-error-box"></div>
          
        </div>
      </html>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Preview Results</title>
      <html>
        <div style="margin-bottom:10px;">
          <strong>Full Query:</strong>
          <pre id="preview-query" style="background:#f5f5f5;padding:10px;border-radius:4px;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word;max-height:200px;overflow-y:auto;">-</pre>
        </div>
        <div style="margin-bottom:10px;">
          <strong>Status:</strong> <span id="preview-status">Pending</span> |
          <strong>Time:</strong> <span id="preview-time">-</span> |
          <strong>Results:</strong> <span id="preview-count">-</span>
        </div>
        <div id="preview-results">Click Preview to run</div>
      </html>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Summary</title>
      <html>
        <table class="table" style="width:auto;">
          <tbody>
            <tr><td style="font-weight:bold;width:150px;">Alert Name:</td><td id="sum-name">-</td></tr>
            <tr><td style="font-weight:bold;">Application:</td><td id="sum-app">-</td></tr>
            <tr><td style="font-weight:bold;">Ticket:</td><td id="sum-ticket">-</td></tr>
            <tr><td style="font-weight:bold;">Email:</td><td id="sum-email">-</td></tr>
            <tr><td style="font-weight:bold;">Priority:</td><td id="sum-priority">-</td></tr>
            <tr><td style="font-weight:bold;">Duration:</td><td id="sum-duration">-</td></tr>
            <tr><td style="font-weight:bold;">Frequency:</td><td id="sum-frequency">-</td></tr>
            <tr><td style="font-weight:bold;">Threshold:</td><td id="sum-threshold">-</td></tr>
            <tr><td style="font-weight:bold;">Throttle:</td><td id="sum-suppression">-</td></tr>
            <tr><td style="font-weight:bold;">Query:</td><td id="sum-query" style="max-width:600px;word-wrap:break-word;font-family:monospace;font-size:11px;">-</td></tr>
          </tbody>
        </table>
        <button class="btn btn-warning" id="btn-ack" disabled="disabled">Acknowledge Configuration</button>
        <span id="ack-status" style="margin-left:10px;"></span>
      </html>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Existing Alerts</title>
      <html>
        <button class="btn btn-default" id="btn-load-alerts">Load Alerts</button>
        <input type="text" id="alert-filter" placeholder="Filter..." style="margin-left:10px;padding:6px;"/>
        <div id="alerts-list" style="margin-top:10px;">Click Load Alerts</div>
      </html>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Activity Log</title>
      <html>
        <button class="btn btn-default btn-sm" id="btn-clear-log">Clear</button>
        <div id="log" style="height:150px;overflow:auto;background:#fafafa;padding:10px;margin-top:10px;font-family:monospace;font-size:12px;">[Ready]</div>
      </html>
    </panel>
  </row>
  
</dashboard>
